<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Team Collaboration Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f9fafb;margin:0;color:#333;}
  header{background:#222;color:#fff;padding:1rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
  main{padding:1rem 2rem;}
  h2,h3{margin:0.3rem 0;}
  button{cursor:pointer;margin-left:4px;}
  .danger{background:#e74c3c;color:white;border:none;padding:0.3rem 0.6rem;border-radius:5px;}
  .project-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1em;}
  .project-box{background:#fff;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1);padding:1rem;transition:0.2s;}
  .project-box:hover{transform:translateY(-2px);}
  .locale-box{background:#fdfdfd;border:1px solid #ddd;border-radius:8px;padding:0.8rem;margin-top:0.8rem;}
  .task-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:0.8em;margin-top:0.5rem;}
  .task-box{background:white;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);padding:0.7rem;display:flex;flex-direction:column;transition:transform 0.2s;}
  .task-box:hover{transform:translateY(-2px);}
  .task-name{font-weight:bold;margin-bottom:0.4rem;}
  .task-controls input,.task-controls select{width:100%;margin-bottom:4px;box-sizing:border-box;border:1px solid #ccc;border-radius:4px;padding:3px;}
  .save-btn{background:#3498db;color:#fff;border:none;border-radius:4px;padding:0.3rem 0.6rem;}
  .box-footer{display:flex;justify-content:space-between;align-items:center;margin-top:0.4rem;}
  .timeline{background:rgba(255,255,255,0.7);border-radius:6px;margin-top:0.5rem;padding:0.4rem 0.6rem;font-size:0.8em;max-height:4.5rem;overflow-y:auto;}
  .timeline-entry{border-left:2px solid #999;padding-left:6px;margin-bottom:4px;}
  .timeline-entry small{color:#555;}
  .timeline-more{color:#0077cc;cursor:pointer;font-size:0.75em;text-align:right;display:block;}
  .progress-container{background:#eee;border-radius:6px;height:8px;overflow:hidden;margin-top:0.5rem;}
  .progress-bar{height:100%;width:0%;background:#e74c3c;border-radius:6px;transition:width 0.4s ease,background 0.4s ease;}
  .progress-label{font-size:0.8em;color:#555;text-align:right;margin-top:0.25rem;}
  #statusManager{background:#fff;padding:0.8rem;margin:1rem 2rem;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.1);}
</style>
</head>

<body>
<header>
  <h1>Project Dashboard</h1>
  <div>
    <button id="addProjectBtn">+ Add Project</button>
    <button id="undoBtn" style="display:none;">Undo Delete</button>
  </div>
</header>

<section id="statusManager">
  <h3>Customize Status Labels</h3>
  <div id="statusList"></div>
  <button id="addStatusBtn">+ Add Status</button>
</section>

<main id="projectContainer"></main>

<footer style="text-align:center;padding:1rem;background:#eee;">
  Last updated: <time id="lastUpdated"></time>
</footer>

<script>
/* ---------- EmailJS Config (optional) ---------- */
const EMAILJS_PUBLIC_KEY='YOUR_PUBLIC_KEY';
const EMAILJS_SERVICE_ID='YOUR_SERVICE_ID';
const EMAILJS_TEMPLATE_ID='YOUR_TEMPLATE_ID';
try{emailjs.init(EMAILJS_PUBLIC_KEY);}catch(e){}

/* ---------- DOM + Data ---------- */
const container=document.getElementById('projectContainer');
const addProjectBtn=document.getElementById('addProjectBtn');
const addStatusBtn=document.getElementById('addStatusBtn');
const undoBtn=document.getElementById('undoBtn');
const lastUpdated=document.getElementById('lastUpdated');
const statusList=document.getElementById('statusList');

let projects=JSON.parse(localStorage.getItem('projects'))||[];
let statuses=JSON.parse(localStorage.getItem('statuses'))||[
 {key:'todo',label:'To Do',color:'#f8d7da'},
 {key:'in-progress',label:'In Progress',color:'#fff3cd'},
 {key:'done',label:'Done',color:'#d4edda'}
];
let lastDeleted=null;

/* ---------- Status Panel ---------- */
function renderStatuses(){
 statusList.innerHTML='';
 statuses.forEach((s,i)=>{
   const row=document.createElement('div');
   row.innerHTML=`<input type="text" value="${s.label}" onchange="updateStatusLabel(${i},this.value)"/>
                  <input type="color" value="${s.color}" onchange="updateStatusColor(${i},this.value)"/>
                  <button onclick="removeStatus(${i})">‚ùå</button>`;
   statusList.appendChild(row);
 });
 localStorage.setItem('statuses',JSON.stringify(statuses));
 renderProjects();
}
function addStatus(){
  const n=prompt('Status name:');
  if(!n)return;
  statuses.push({key:n.toLowerCase().replace(/\s+/g,'-'),label:n,color:'#e0e0e0'});
  renderStatuses();
}
function updateStatusLabel(i,v){statuses[i].label=v;renderStatuses();}
function updateStatusColor(i,v){statuses[i].color=v;renderStatuses();}
function removeStatus(i){if(confirm('Delete this status?')){statuses.splice(i,1);renderStatuses();}}

/* ---------- Rendering Projects/Locales/Tasks ---------- */
function renderProjects(){
 container.innerHTML='';
 const pg=document.createElement('div');pg.className='project-grid';container.appendChild(pg);

 projects.forEach((p,pIdx)=>{
   const projectBox=document.createElement('div');
   projectBox.classList.add('project-box');
   projectBox.innerHTML=`<h2>${p.name}</h2>
     <button onclick="addLocale(${pIdx})">+ Add Locale</button>
     <button class="danger" onclick="removeProject(${pIdx})">Delete Project</button>`;
   pg.appendChild(projectBox);

   const allTasks=p.locales.flatMap(l=>l.tasks);
   const totalTasks=allTasks.length,doneTasks=allTasks.filter(t=>t.status==='done').length;
   const percent=totalTasks?Math.round((doneTasks/totalTasks)*100):0;
   let color='#e74c3c';if(percent>=66)color='#27ae60';else if(percent>=33)color='#f1c40f';
   const pb=document.createElement('div');
   pb.innerHTML=`<div class="progress-container"><div class="progress-bar" style="width:${percent}%;background:${color};"></div></div>
                 <div class="progress-label">${percent}% complete (${doneTasks}/${totalTasks})</div>`;
   projectBox.appendChild(pb);

   p.locales.forEach((loc,lIdx)=>{
     const locDiv=document.createElement('div');
     locDiv.classList.add('locale-box');
     locDiv.innerHTML=`<h3>Locale: ${loc.name}</h3>
       <button onclick="addTask(${pIdx},${lIdx})">+ Add Task</button>
       <button class="danger" onclick="removeLocale(${pIdx},${lIdx})">Delete Locale</button>`;

     const total=loc.tasks.length,done=loc.tasks.filter(t=>t.status==='done').length;
     const pct=total?Math.round((done/total)*100):0;
     let c='#e74c3c';if(pct>=66)c='#27ae60';else if(pct>=33)c='#f1c40f';
     const progress=document.createElement('div');
     progress.innerHTML=`<div class="progress-container"><div class="progress-bar" style="width:${pct}%;background:${c};"></div></div>
                         <div class="progress-label">${pct}% complete (${done}/${total})</div>`;
     locDiv.appendChild(progress);

     const taskGrid=document.createElement('div');taskGrid.classList.add('task-grid');
     loc.tasks.forEach((t,tIdx)=>{
       const s=statuses.find(x=>x.key===t.status)||statuses[0];
       const taskDiv=document.createElement('div');taskDiv.classList.add('task-box');
       taskDiv.style.background=s.color;

       /* timeline HTML with mapped labels */
       let timelineHTML='';
       if(t.history&&t.history.length>0){
         const recent=[...t.history].slice(-3).reverse();
         timelineHTML=recent.map(h=>{
           const fromLabel=(statuses.find(s=>s.key===h.from)?.label)||h.from;
           const toLabel=(statuses.find(s=>s.key===h.to)?.label)||h.to;
           return `<div class="timeline-entry"><div>${fromLabel} ‚Üí ${toLabel}</div><small>${h.time}</small></div>`;
         }).join('');
         if(t.history.length>3)
           timelineHTML+=`<span class="timeline-more" onclick="viewHistory(${pIdx},${lIdx},${tIdx})">View full</span>`;
       }else{
         timelineHTML='<div class="timeline-entry"><small>No history yet</small></div>';
       }

       taskDiv.innerHTML=`
         <div class="task-name">${t.name}</div>
         <div class="task-controls">
           <input type="email" placeholder="Assignee email"
                  value="${t.assignee||''}" onchange="updateAssignee(${pIdx},${lIdx},${tIdx},this.value)" />
           <select id="status-${pIdx}-${lIdx}-${tIdx}">
             ${statuses.map(st=>`<option value="${st.key}" ${t.status===st.key?'selected':''}>${st.label}</option>`).join('')}
           </select>
           <button class="save-btn" onclick="saveStatus(${pIdx},${lIdx},${tIdx})">üíæ Save</button>
         </div>
         <div class="timeline">${timelineHTML}</div>
         <div class="box-footer">
           <button class="danger" onclick="removeTask(${pIdx},${lIdx},${tIdx})">üóë</button>
         </div>`;
       taskGrid.appendChild(taskDiv);
     });
     locDiv.appendChild(taskGrid);
     projectBox.appendChild(locDiv);
   });
 });
 lastUpdated.textContent=new Date().toLocaleString();
 localStorage.setItem('projects',JSON.stringify(projects));
 undoBtn.style.display=lastDeleted?'inline-block':'none';
}

/* ---------- CRUD ---------- */
function addProject(){const n=prompt('Project name:');if(!n)return;projects.push({name:n,locales:[]});renderProjects();}
function removeProject(i){if(confirm('Delete this project?')){lastDeleted={type:'project',data:projects[i],index:i};projects.splice(i,1);renderProjects();}}
function addLocale(p){const n=prompt('Locale:');if(!n)return;projects[p].locales.push({name:n,tasks:[]});renderProjects();}
function removeLocale(p,l){if(confirm('Delete locale?')){lastDeleted={type:'locale',data:projects[p].locales[l],parent:p,index:l};projects[p].locales.splice(l,1);renderProjects();}}
function addTask(p,l){const n=prompt('Task name:');if(!n)return;projects[p].locales[l].tasks.push({name:n,status:statuses[0].key,history:[]});renderProjects();}
function removeTask(p,l,t){if(confirm('Delete task?')){lastDeleted={type:'task',data:projects[p].locales[l].tasks[t],parentP:p,parentL:l,index:t};projects[p].locales[l].tasks.splice(t,1);renderProjects();}}

/* ---------- Status + Assignee + History ---------- */
function saveStatus(p,l,t){
  const select=document.getElementById(`status-${p}-${l}-${t}`);
  const newVal=select.value;
  updateStatus(p,l,t,newVal);
}
function updateStatus(p,l,t,newVal){
  const task=projects[p].locales[l].tasks[t];
  const oldStatus=task.status||'(none)';
  const now=new Date().toLocaleString();
  if(!task.history)task.history=[];
  task.history.push({from:oldStatus,to:newVal,by:'self',time:now});
  task.status=newVal;
  localStorage.setItem('projects',JSON.stringify(projects));
  renderProjects();
}
function updateAssignee(p,l,t,email){
  const task=projects[p].locales[l].tasks[t];
  task.assignee=email;
  if(email&&EMAILJS_SERVICE_ID){
    emailjs.send(EMAILJS_SERVICE_ID,EMAILJS_TEMPLATE_ID,{
      to_email:email,project_name:projects[p].name,task_name:task.name
    });
  }
  renderProjects();
}
function viewHistory(p,l,t){
  const task=projects[p].locales[l].tasks[t];
  if(!task.history||!task.history.length){
    alert(`History for "${task.name}":\n\nNo changes yet.`);
    return;
  }
  const log=task.history.map(h=>{
    const fromLabel=(statuses.find(s=>s.key===h.from)?.label)||h.from;
    const toLabel=(statuses.find(s=>s.key===h.to)?.label)||h.to;
    return `‚Ä¢ ${h.time}: ${fromLabel} ‚Üí ${toLabel} by ${h.by}`;
  }).join('\n');
  alert(`History for "${task.name}":\n\n${log}`);
}

/* ---------- Undo ---------- */
function undoLastDelete(){
  if(!lastDeleted)return;
  const d=lastDeleted;
  switch(d.type){
    case'project':projects.splice(d.index,0,d.data);break;
    case'locale':projects[d.parent].locales.splice(d.index,0,d.data);break;
    case'task':projects[d.parentP].locales[d.parentL].tasks.splice(d.index,0,d.data);break;
  }
  lastDeleted=null;renderProjects();
}

/* ---------- Init ---------- */
addProjectBtn.onclick=addProject;
addStatusBtn.onclick=addStatus;
undoBtn.onclick=undoLastDelete;
renderStatuses();
</script>
</body>
</html>